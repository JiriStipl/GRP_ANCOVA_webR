[{"name":"app.R","content":"#\r\n# This is a Shiny web application. You can run the application by clicking\r\n# the 'Run App' button above.\r\n#\r\n# Find out more about building applications with Shiny here:\r\n#\r\n#    https://shiny.posit.co/\r\n#\r\n\r\nlibrary(shiny)\r\n#library(haven)\r\n#d <- read_sav(\"data.sav\")\r\nd <- read.csv(\"data.csv\")\r\nlibrary(ggplot2)\r\n\r\n# 1. LOAD AND PREP DATA ---------------------------------------------------\r\nif (file.exists(\"data.sav\")) {\r\n  raw_d <- read_sav(\"data.sav\")\r\n  \r\n  # Data Cleaning & Factor conversion\r\n  d <- raw_d\r\n  d$group  <- as_factor(d$group)  # HC vs MDD\r\n  d$gender <- as_factor(d$gender) # male vs female\r\n  \r\n  # Rename levels for cleaner plotting\r\n  levels(d$group) <- c(\"Healthy Control\", \"MDD\")\r\n  levels(d$gender) <- c(\"Male\", \"Female\")\r\n  \r\n} else {\r\n  # Fallback for testing if file missing (creates dummy structure)\r\n  d <- data.frame(group=factor(c(\"HC\",\"MDD\")), TAU=c(1,2), IQ=c(100,90))\r\n  warning(\"data.sav not found. App will crash on interaction.\")\r\n}\r\n\r\n# Variable Name Mapping (For pretty UI labels)\r\ndv_choices <- c(\r\n  \"Resource Variability (TAU)\" = \"TAU\",\r\n  \"Initial Resources (J1)\" = \"J1\",\r\n  \"Memory Error (Set Size 1)\" = \"setsize1_CSD\",\r\n  \"Memory Error (Set Size 2)\" = \"setsize2_CSD\",\r\n  \"Memory Error (Set Size 4)\" = \"setsize4_CSD\",\r\n  \"Memory Error (Set Size 6)\" = \"setsize6_CSD\",\r\n  \"Cognitive Ability (IQ)\" = \"IQ\" # Added as potential outcome\r\n)\r\n\r\ncov_choices <- c(\r\n  \"Color Perception (base_CSD)\" = \"base_CSD\",\r\n  \"Age\" = \"age\",\r\n  \"Cognitive Ability (IQ)\" = \"IQ\",\r\n  \"Depression Severity (BDI)\" = \"BDI\"\r\n)\r\n\r\n# 2. UI LAYOUT ------------------------------------------------------------\r\nui <- fluidPage(\r\n  \r\n  titlePanel(\"ANCOVA: vWM & Depression (Kong et al., 2025)\"),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      h4(\"1. Dependent Variable\"),\r\n      selectInput(\"dv\", \"Dependent Variable (Outcome):\", choices = dv_choices),\r\n      \r\n      hr(),\r\n      h4(\"2. Grouping Variables\"),\r\n      checkboxGroupInput(\"ivs\", \"Independent Variables:\",\r\n                         choices = c(\"Group (MDD vs HC)\" = \"group\",\r\n                                     \"Sex (Male vs Female)\" = \"gender\"),\r\n                         selected = c(\"group\", \"gender\")),\r\n      \r\n      hr(),\r\n      h4(\"3. Statistical Adjustments\"),\r\n      p(class = \"text-muted\", \"Select variables to 'control for' in the ANCOVA model.\"),\r\n      checkboxGroupInput(\"covs\", \"Covariates:\",\r\n                         choices = cov_choices,\r\n                         selected = \"base_CSD\"), # Default to the \"Good\" covariate\r\n      \r\n      hr(),\r\n      helpText(\"Note: The plots update automatically.\")\r\n    ),\r\n    \r\n    mainPanel(\r\n      tabsetPanel(\r\n        # TAB 1: The \"Figure 3\" Replica\r\n        tabPanel(\"Group Comparison\", \r\n                 br(),\r\n                 h4(\"Group Differences (Mean +/- SE)\"),\r\n                 p(\"The bars show the raw data. The significance lines (stars) come from your specific Model.\"),\r\n                 plotOutput(\"barPlot\", height = \"500px\")\r\n        ),\r\n        \r\n        # TAB 2: Effect Sizes\r\n        tabPanel(\"Effect Sizes (Coefficients)\", \r\n                 br(),\r\n                 h4(\"Regression Coefficients\"),\r\n                 p(\"How much does the effect size changes when you add covariates?\"),\r\n                 plotOutput(\"coefPlot\", height = \"450px\")\r\n        ),\r\n        \r\n        # TAB 3: Raw Output\r\n        tabPanel(\"Model Summary\", \r\n                 br(),\r\n                 verbatimTextOutput(\"modelSum\")\r\n        )\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n# 3. SERVER LOGIC ---------------------------------------------------------\r\nserver <- function(input, output, session) {\r\n  \r\n  # --- DYNAMIC UI LOGIC ---\r\n  # Prevent selecting IQ as both DV and Covariate\r\n  observeEvent(input$dv, {\r\n    current_covs <- input$covs\r\n    \r\n    if (input$dv == \"IQ\") {\r\n      # Remove IQ from covariate choices\r\n      updateCheckboxGroupInput(session, \"covs\",\r\n                               choices = cov_choices[cov_choices != \"IQ\"],\r\n                               selected = current_covs[current_covs != \"IQ\"])\r\n    } else {\r\n      # Restore IQ to covariate choices (maintain selection state)\r\n      updateCheckboxGroupInput(session, \"covs\",\r\n                               choices = cov_choices,\r\n                               selected = current_covs)\r\n    }\r\n  })\r\n  \r\n  # --- MODEL BUILDING ---\r\n  current_model <- reactive({\r\n    req(input$ivs) # Require at least one IV\r\n    \r\n    # Combine IVs and Covariates\r\n    predictors <- c(input$ivs, input$covs)\r\n    \r\n    # Formula construction\r\n    f <- as.formula(paste(input$dv, \"~\", paste(predictors, collapse = \" + \")))\r\n    \r\n    lm(f, data = d)\r\n  })\r\n  \r\n  # --- PLOT 1: BAR CHART WITH STARS (The \"Fig 3\" Replica) ---\r\n  # --- PLOT 1: BAR CHART WITH STARS (The \"Fig 3\" Replica) ---\r\n  output$barPlot <- renderPlot({\r\n    req(input$ivs) # Require at least one IV\r\n    \r\n    # 1. Dynamic Aggregation based on selected IVs\r\n    # We construct a formula like \"TAU ~ group + gender\" dynamically\r\n    agg_formula <- as.formula(paste(input$dv, \"~\", paste(input$ivs, collapse = \"+\")))\r\n    \r\n    # Calculate Mean and SE\r\n    # (Using base R aggregate to ensure WebR compatibility without dplyr)\r\n    agg_res <- aggregate(agg_formula, data = d, \r\n                         FUN = function(x) c(mean = mean(x, na.rm=TRUE), \r\n                                             se = sd(x, na.rm=TRUE)/sqrt(length(x))))\r\n    \r\n    # Clean up the weird matrix output from aggregate\r\n    plot_data <- cbind(agg_res[, input$ivs, drop=FALSE], agg_res[[input$dv]])\r\n    \r\n    # 2. Extract P-value for the significance bracket\r\n    # We prioritize showing the \"Group\" effect because that's the focus of the MDD lesson\r\n    mod <- current_model()\r\n    coefs <- summary(mod)$coefficients\r\n    \r\n    # Find the row for Group (MDD). \r\n    group_row <- grep(\"group\", rownames(coefs))\r\n    \r\n    if (length(group_row) > 0 && \"group\" %in% input$ivs) {\r\n      pval <- coefs[group_row, 4]\r\n      \r\n      # Determine Star Label\r\n      if (pval < 0.001) { star_label <- \"***\" }\r\n      else if (pval < 0.01) { star_label <- \"**\" }\r\n      else if (pval < 0.05) { star_label <- \"*\" }\r\n      else { star_label <- \"ns\" }\r\n      \r\n      show_bracket <- TRUE\r\n    } else {\r\n      star_label <- \"\"\r\n      show_bracket <- FALSE\r\n    }\r\n    \r\n    # 3. Calculate Y-positions for the bracket\r\n    y_max <- max(plot_data$mean + plot_data$se)\r\n    bracket_y <- y_max * 1.10\r\n    label_y <- y_max * 1.15\r\n    \r\n    # 4. Draw Plot based on selection\r\n    p <- ggplot(plot_data) + theme_classic(base_size = 18)\r\n    \r\n    # LOGIC: How to map X and Fill based on checkboxes\r\n    if (\"group\" %in% input$ivs && \"gender\" %in% input$ivs) {\r\n      # Case A: Both Group and Gender (Like Fig 3)\r\n      p <- p + aes(x = group, y = mean, fill = gender) +\r\n        geom_bar(stat = \"identity\", position = position_dodge(0.9), width = 0.7) +\r\n        geom_errorbar(aes(ymin = mean - se, ymax = mean + se), \r\n                      position = position_dodge(0.9), width = 0.2) +\r\n        scale_fill_manual(values = c(\"Male\" = \"#999999\", \"Female\" = \"#56B4E9\"))\r\n      \r\n    } else if (\"group\" %in% input$ivs) {\r\n      # Case B: Only Group\r\n      p <- p + aes(x = group, y = mean, fill = group) +\r\n        geom_bar(stat = \"identity\", width = 0.6) +\r\n        geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +\r\n        scale_fill_manual(values = c(\"Healthy Control\" = \"#999999\", \"MDD\" = \"#56B4E9\")) +\r\n        theme(legend.position = \"none\")\r\n      \r\n    } else if (\"gender\" %in% input$ivs) {\r\n      # Case C: Only Gender\r\n      p <- p + aes(x = gender, y = mean, fill = gender) +\r\n        geom_bar(stat = \"identity\", width = 0.6) +\r\n        geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +\r\n        scale_fill_manual(values = c(\"Male\" = \"#999999\", \"Female\" = \"#56B4E9\")) +\r\n        theme(legend.position = \"none\")\r\n    }\r\n    \r\n    # Add the bracket if Group is involved (The main lesson)\r\n    if (show_bracket) {\r\n      # We place the bracket over the main group categories\r\n      p <- p + \r\n        annotate(\"segment\", x = 1, xend = 1, y = y_max, yend = bracket_y) + \r\n        annotate(\"segment\", x = 2, xend = 2, y = y_max, yend = bracket_y) + \r\n        annotate(\"segment\", x = 1, xend = 2, y = bracket_y, yend = bracket_y) + \r\n        annotate(\"text\", x = 1.5, y = label_y, label = star_label, size = 8, fontface = \"bold\")\r\n    }\r\n    \r\n    # Final labels\r\n    p <- p + labs(y = input$dv, title = paste(\"Comparison of\", input$dv),\r\n                  subtitle = paste(\"Significance test controls for:\", paste(input$covs, collapse=\", \")))\r\n    \r\n    p\r\n  })\r\n  \r\n  # --- PLOT 2: COEFFICIENT PLOT (Effect Sizes) ---\r\n  output$coefPlot <- renderPlot({\r\n    mod <- current_model()\r\n    coefs <- summary(mod)$coefficients\r\n    ci <- confint(mod)\r\n    \r\n    plot_data <- data.frame(\r\n      Term = rownames(coefs),\r\n      Estimate = coefs[,1],\r\n      Lower = ci[,1],\r\n      Upper = ci[,2],\r\n      Pval = coefs[,4]\r\n    )\r\n    \r\n    # Clean up labels\r\n    plot_data$Significance <- ifelse(plot_data$Pval < 0.05, \"Significant\", \"Not Sig\")\r\n    plot_data <- plot_data[plot_data$Term != \"(Intercept)\", ]\r\n    \r\n    ggplot(plot_data, aes(x = reorder(Term, abs(Estimate)), y = Estimate, color = Significance)) +\r\n      geom_hline(yintercept = 0, linetype = \"dashed\") +\r\n      geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0.2, size = 1) +\r\n      geom_point(size = 4) +\r\n      coord_flip() +\r\n      scale_color_manual(values = c(\"Significant\" = \"firebrick\", \"Not Sig\" = \"grey60\")) +\r\n      labs(x = \"Predictor\", y = \"Beta Coefficient\", \r\n           title = \"How big is the effect?\"\r\n           #subtitle = \"Watch the 'groupMDD' bar shrink when you add IQ!\"\r\n           ) +\r\n      theme_bw(base_size = 16)\r\n  })\r\n  \r\n  # --- TEXT SUMMARY ---\r\n  output$modelSum <- renderPrint({\r\n    summary(current_model())\r\n  })\r\n}\r\n\r\n# 4. RUN APP --------------------------------------------------------------\r\nshinyApp(ui = ui, server = server)\r\n\r\n\r\n# GRP_ANCOVA","type":"text"},{"name":"GRP_ANCOVA.Rproj","content":"Version: 1.0\r\n\r\nRestoreWorkspace: Default\r\nSaveWorkspace: Default\r\nAlwaysSaveHistory: Default\r\n\r\nEnableCodeIndexing: Yes\r\nUseSpacesForTab: Yes\r\nNumSpacesForTab: 2\r\nEncoding: UTF-8\r\n\r\nRnwWeave: Sweave\r\nLaTeX: pdfLaTeX\r\n","type":"text"}]
